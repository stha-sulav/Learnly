@page "{id:int?}"
@model Learnly.Areas.Instructor.Pages.Courses.CourseEditModel
@{
    ViewData["Title"] = Model.IsEditMode ? "Edit Course" : "Create New Course";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <partial name="_HomeBreadcrumb" />
                    <li class="breadcrumb-item"><a asp-area="Instructor" asp-page="/Courses/CourseList"><i class="bi bi-journals me-1"></i>My Courses</a></li>
                    <li class="breadcrumb-item active" aria-current="page"><i class="bi @(Model.IsEditMode ? "bi-pencil-square" : "bi-plus-circle") me-1"></i>@ViewData["Title"]</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>@ViewData["Title"]</h1>
                <a asp-page="./CourseList" class="btn btn-outline-secondary">Back to Courses</a>
            </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@Model.SuccessMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@Model.ErrorMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                <div asp-validation-summary="All" class="text-danger"></div>
                <input type="hidden" asp-for="Course.Id" />
                <input type="hidden" asp-for="Course.ThumbnailPath" />
                <input type="hidden" asp-for="Course.InstructorId" />

                <div class="mb-3">
                    <label asp-for="Course.Title" class="form-label"></label>
                    <input asp-for="Course.Title" class="form-control" />
                    <span asp-validation-for="Course.Title" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Course.Description" class="form-label"></label>
                    <textarea asp-for="Course.Description" class="form-control" rows="5"></textarea>
                    <span asp-validation-for="Course.Description" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Course.CategoryId" class="form-label"></label>
                    <select asp-for="Course.CategoryId" asp-items="Model.Categories" class="form-select">
                        <option value="">-- Select Category --</option>
                    </select>
                    <span asp-validation-for="Course.CategoryId" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label class="form-label">Course Thumbnail</label>
                    <div class="mb-2">
                        <div class="position-relative rounded overflow-hidden" style="width: 200px; height: 150px; background: linear-gradient(135deg, var(--bs-primary) 0%, var(--bs-indigo) 100%);">
                            <div class="d-flex align-items-center justify-content-center position-absolute top-0 start-0 w-100 h-100">
                                <i class="bi bi-play-circle text-white" style="font-size: 3rem;"></i>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.Course.ThumbnailPath))
                            {
                                <img src="@Model.Course.ThumbnailPath" alt="Current thumbnail" class="position-absolute top-0 start-0 w-100 h-100" style="object-fit: cover;" onerror="this.style.display='none';" />
                            }
                        </div>
                        <p class="text-muted small mt-1">@(!string.IsNullOrWhiteSpace(Model.Course.ThumbnailPath) ? "Current thumbnail" : "Default thumbnail (upload to change)")</p>
                    </div>
                    <input type="file" asp-for="ThumbnailFile" class="form-control" accept="image/*" />
                    <small class="form-text text-muted">Accepted formats: JPG, PNG, GIF, WebP. Max size: 5MB</small>
                    <span asp-validation-for="ThumbnailFile" class="text-danger"></span>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" asp-for="Course.IsPublished" class="form-check-input" />
                    <label class="form-check-label" asp-for="Course.IsPublished"></label>
                </div>

                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-save me-2"></i> @(Model.IsEditMode ? "Update Course" : "Create Course")
                </button>
            </form>
        </div>
    </div>

    @if (Model.IsEditMode)
    {
        <div class="card shadow-sm mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Course Curriculum</h3>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addModuleModal">
                    <i class="bi bi-plus-lg me-1"></i>Add Module
                </button>
            </div>
            <div class="card-body">
                <div id="modules-tree" class="modules-tree">
                    <!-- Tree view will be loaded here dynamically -->
                </div>
                <div id="empty-state" class="text-center py-5 text-muted" style="display: none;">
                    <i class="bi bi-folder2-open display-4"></i>
                    <p class="mt-3">No modules yet. Click "Add Module" to get started.</p>
                </div>
            </div>
        </div>

        <!-- Add Module Modal -->
        <div class="modal fade" id="addModuleModal" tabindex="-1" aria-labelledby="addModuleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addModuleModalLabel"><i class="bi bi-folder-plus me-2"></i>Add New Module</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="new-module-title" class="form-label">Module Title <span class="text-danger">*</span></label>
                            <input type="text" id="new-module-title" class="form-control" placeholder="e.g., Introduction to the Course" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Module Thumbnail</label>
                            <div id="new-module-thumbnail-preview" class="mb-2">
                                <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 120px; height: 90px;">
                                    <i class="bi bi-layers text-white" style="font-size: 2rem;"></i>
                                </div>
                                <small class="text-muted">Default thumbnail</small>
                            </div>
                            <input type="file" id="new-module-thumbnail" class="form-control" accept="image/*" />
                            <small class="form-text text-muted">Accepted formats: JPG, PNG, GIF, WebP. Max size: 5MB</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="add-module-btn" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add Module</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Lesson Modal -->
        <div class="modal fade" id="addLessonModal" tabindex="-1" aria-labelledby="addLessonModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addLessonModalLabel"><i class="bi bi-file-earmark-plus me-2"></i>Add New Lesson</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="lesson-module-id" />
                        <div class="mb-3">
                            <label for="new-lesson-title" class="form-label">Lesson Title <span class="text-danger">*</span></label>
                            <input type="text" id="new-lesson-title" class="form-control" placeholder="e.g., Getting Started" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lesson Thumbnail</label>
                            <div id="new-lesson-thumbnail-preview" class="mb-2">
                                <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 120px; height: 90px;">
                                    <i class="bi bi-book text-white" style="font-size: 2rem;"></i>
                                </div>
                                <small class="text-muted">Default thumbnail</small>
                            </div>
                            <input type="file" id="new-lesson-thumbnail" class="form-control" accept="image/*" />
                            <small class="form-text text-muted">Accepted formats: JPG, PNG, GIF, WebP. Max size: 5MB</small>
                        </div>
                        <div class="mb-3">
                            <label for="lesson-video-upload" class="form-label">Video File <span class="text-danger">*</span></label>
                            <input type="file" id="lesson-video-upload" class="form-control" accept="video/mp4" required />
                            <small class="form-text text-muted">Supported format: MP4. Max size: 500MB. <strong>Required for all lessons.</strong></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="add-lesson-btn" class="btn btn-primary"><i class="bi bi-plus-lg me-1"></i>Add Lesson</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Module Modal -->
        <div class="modal fade" id="editModuleModal" tabindex="-1" aria-labelledby="editModuleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModuleModalLabel"><i class="bi bi-pencil me-2"></i>Edit Module</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-module-id" />
                        <div class="mb-3">
                            <label for="edit-module-title" class="form-label">Module Title <span class="text-danger">*</span></label>
                            <input type="text" id="edit-module-title" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Module Thumbnail</label>
                            <div id="edit-module-thumbnail-preview" class="mb-2">
                                <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 120px; height: 90px;">
                                    <i class="bi bi-layers text-white" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                            <input type="file" id="edit-module-thumbnail" class="form-control" accept="image/*" />
                            <small class="form-text text-muted">Accepted formats: JPG, PNG, GIF, WebP. Max size: 5MB</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="save-module-btn" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Lesson Modal -->
        <div class="modal fade" id="editLessonModal" tabindex="-1" aria-labelledby="editLessonModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editLessonModalLabel"><i class="bi bi-pencil me-2"></i>Edit Lesson</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="edit-lesson-id" />
                        <div class="mb-3">
                            <label for="edit-lesson-title" class="form-label">Lesson Title <span class="text-danger">*</span></label>
                            <input type="text" id="edit-lesson-title" class="form-control" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Lesson Thumbnail</label>
                            <div id="edit-lesson-thumbnail-preview" class="mb-2">
                                <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 120px; height: 90px;">
                                    <i class="bi bi-book text-white" style="font-size: 2rem;"></i>
                                </div>
                            </div>
                            <input type="file" id="edit-lesson-thumbnail" class="form-control" accept="image/*" />
                            <small class="form-text text-muted">Accepted formats: JPG, PNG, GIF, WebP. Max size: 5MB</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="save-lesson-btn" class="btn btn-primary"><i class="bi bi-check-lg me-1"></i>Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="bi bi-exclamation-triangle me-2"></i>Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="delete-confirm-message">Are you sure you want to delete this item?</p>
                        <p class="text-muted small mb-0"><i class="bi bi-info-circle me-1"></i>This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Cancel</button>
                        <button type="button" id="confirm-delete-btn" class="btn btn-danger"><i class="bi bi-trash me-1"></i>Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Module Quiz Modal -->
        <div class="modal fade" id="moduleQuizModal" tabindex="-1" aria-labelledby="moduleQuizModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="moduleQuizModalLabel"><i class="bi bi-question-circle me-2"></i>Module Quiz</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="quiz-module-id" />
                        <input type="hidden" id="quiz-id" />
                        <div id="quiz-info" class="mb-3">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Module quizzes help ensure students understand the content before moving on. Students must score at least 70% to unlock the next module.
                            </div>
                        </div>
                        <div id="quiz-form">
                            <div class="mb-3">
                                <label for="quiz-title" class="form-label">Quiz Title <span class="text-danger">*</span></label>
                                <input type="text" id="quiz-title" class="form-control" placeholder="e.g., Module 1 Quiz" required />
                            </div>
                        </div>
                        <div id="quiz-exists" style="display: none;">
                            <div class="d-flex align-items-center justify-content-between p-3 bg-light rounded mb-3">
                                <div>
                                    <strong id="existing-quiz-title"></strong>
                                    <div class="text-muted small">Passing score: 70%</div>
                                </div>
                                <a id="manage-questions-link" href="#" class="btn btn-sm btn-primary">
                                    <i class="bi bi-list-check me-1"></i>Manage Questions
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" id="delete-quiz-btn" class="btn btn-outline-danger" style="display: none;">
                            <i class="bi bi-trash me-1"></i>Delete Quiz
                        </button>
                        <button type="button" id="save-quiz-btn" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Save Quiz
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
        </div>
    </div>
</div>

<style>
    .modules-tree .module-item {
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    .modules-tree .module-header {
        background: linear-gradient(135deg, var(--bs-gray-100) 0%, var(--bs-gray-200) 100%);
        padding: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: background-color 0.2s;
        border-radius: 8px 8px 0 0;
    }
    .modules-tree .module-header.collapsed {
        border-radius: 8px;
    }
    .modules-tree .module-header:hover {
        background: linear-gradient(135deg, var(--bs-gray-200) 0%, var(--bs-gray-300) 100%);
    }
    .modules-tree .module-header .module-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
        min-width: 0;
    }
    .modules-tree .module-header .module-actions {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        flex-shrink: 0;
    }
    .modules-tree .module-header .module-actions .btn:not(.dropdown-toggle):not(.add-lesson-trigger) {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0;
    }
    .modules-tree .module-header .module-actions .btn.dropdown-toggle,
    .modules-tree .module-header .module-actions .btn.add-lesson-trigger {
        height: 32px;
        padding: 0 0.75rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        font-size: 0.8125rem;
    }
    .modules-tree .module-header .module-actions .btn i {
        font-size: 0.875rem;
    }
    .modules-tree .module-header .module-toggle {
        transition: transform 0.3s;
    }
    .modules-tree .module-header.collapsed .module-toggle {
        transform: rotate(-90deg);
    }
    .modules-tree .module-body {
        border-top: 1px solid var(--bs-border-color);
        padding: 0;
        border-radius: 0 0 8px 8px;
    }
    .modules-tree .lessons-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .modules-tree .lesson-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border-bottom: 1px solid var(--bs-border-color);
        transition: background-color 0.2s;
    }
    .modules-tree .lesson-item:last-child {
        border-bottom: none;
    }
    .modules-tree .lesson-item:hover {
        background-color: var(--bs-tertiary-bg);
    }
    .modules-tree .lesson-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        background: transparent;
    }
    .modules-tree .lesson-item:hover .lesson-info {
        background: inherit;
    }
    .modules-tree .lesson-info span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .modules-tree .lesson-actions {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        flex-shrink: 0;
        margin-left: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .modules-tree .lesson-actions .btn {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin: 0;
    }
    .modules-tree .lesson-actions .btn i {
        font-size: 0.875rem;
    }
    .modules-tree .lesson-item:hover .lesson-actions {
        opacity: 1;
    }
    .modules-tree .add-lesson-row {
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        background-color: var(--bs-tertiary-bg);
    }
    .modules-tree .empty-lessons {
        padding: 1.5rem;
        text-align: center;
        color: var(--bs-secondary);
        font-style: italic;
    }
    .modules-tree .module-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    .modules-tree .quiz-item {
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        border-top: 1px dashed var(--bs-border-color);
    }
    .modules-tree .quiz-item:hover {
        background-color: var(--bs-tertiary-bg);
    }
</style>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    @if (Model.IsEditMode)
    {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const courseId = @Model.Course.Id;
                const modulesTree = document.getElementById('modules-tree');
                const emptyState = document.getElementById('empty-state');
                const requestVerificationToken = document.querySelector('meta[name="RequestVerificationToken"]').content;

                // Modal elements
                const addModuleModal = new bootstrap.Modal(document.getElementById('addModuleModal'));
                const addLessonModal = new bootstrap.Modal(document.getElementById('addLessonModal'));
                const editModuleModal = new bootstrap.Modal(document.getElementById('editModuleModal'));
                const editLessonModal = new bootstrap.Modal(document.getElementById('editLessonModal'));
                const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

                // Store modules data
                let modulesData = [];

                // Delete confirmation state
                let deleteCallback = null;

                // Confirmation dialog helper
                function showDeleteConfirm(message, callback) {
                    document.getElementById('delete-confirm-message').textContent = message;
                    deleteCallback = callback;
                    deleteConfirmModal.show();
                }

                // Handle confirm delete button click
                document.getElementById('confirm-delete-btn').addEventListener('click', async function() {
                    if (deleteCallback) {
                        await deleteCallback();
                        deleteCallback = null;
                    }
                    deleteConfirmModal.hide();
                });

                // Load all modules and their lessons
                async function loadModules() {
                    try {
                        const response = await fetch(`/api/Modules/ByCourse/${courseId}`);
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Failed to load modules:', response.status, errorText);
                            showAlert(`Failed to load modules: ${response.status}`, 'error');
                            return;
                        }
                        modulesData = await response.json();

                        // Load lessons and quiz for each module
                        for (const module of modulesData) {
                            const lessonsResponse = await fetch(`/api/Lessons/ByModule/${module.id}`);
                            if (lessonsResponse.ok) {
                                module.lessons = await lessonsResponse.json();
                            } else {
                                module.lessons = [];
                            }

                            // Load quiz for this module
                            const quizResponse = await fetch(`/api/Quiz/ByModule/${module.id}`);
                            if (quizResponse.ok) {
                                module.quiz = await quizResponse.json();
                            } else {
                                module.quiz = null;
                            }
                        }

                        renderTree();
                    } catch (error) {
                        showAlert('An error occurred while loading modules.', 'error');
                    }
                }

                function renderTree() {
                    modulesTree.innerHTML = '';

                    if (modulesData.length === 0) {
                        emptyState.style.display = 'block';
                        return;
                    }

                    emptyState.style.display = 'none';

                    modulesData.forEach((module, index) => {
                        const moduleEl = document.createElement('div');
                        moduleEl.className = 'module-item';
                        moduleEl.dataset.moduleId = module.id;

                        const lessonCount = module.lessons ? module.lessons.length : 0;
                        const thumbnailHtml = module.thumbnailPath
                            ? `<img src="${module.thumbnailPath}" alt="${module.title}" class="module-thumbnail rounded" style="width: 40px; height: 30px; object-fit: cover;">`
                            : `<div class="module-thumbnail-default bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 40px; height: 30px;"><i class="bi bi-layers text-white"></i></div>`;

                        moduleEl.innerHTML = `
                            <div class="module-header" data-module-id="${module.id}">
                                <div class="module-info">
                                    <i class="bi bi-chevron-down module-toggle"></i>
                                    ${thumbnailHtml}
                                    <strong>${module.title}</strong>
                                    <span class="badge bg-secondary module-badge">${lessonCount} lesson${lessonCount !== 1 ? 's' : ''}</span>
                                </div>
                                <div class="module-actions">
                                    ${!module.quiz ? `
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-plus-lg me-1"></i>Add
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item add-lesson-trigger" href="#" data-module-id="${module.id}"><i class="bi bi-play-btn me-2"></i>Add Lesson</a></li>
                                            <li><a class="dropdown-item add-quiz-link" href="#" data-module-id="${module.id}"><i class="bi bi-question-circle me-2"></i>Add Quiz</a></li>
                                        </ul>
                                    </div>
                                    ` : `
                                    <button class="btn btn-sm btn-primary add-lesson-trigger" data-module-id="${module.id}" title="Add Lesson">
                                        <i class="bi bi-plus-lg me-1"></i>Add Lesson
                                    </button>
                                    `}
                                    <button class="btn btn-sm btn-outline-primary edit-module-trigger" data-module-id="${module.id}" data-module-title="${module.title}" data-module-thumbnail="${module.thumbnailPath || ''}" title="Edit Module">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-module-trigger" data-module-id="${module.id}" title="Delete Module">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="module-body" id="module-body-${module.id}">
                                ${renderLessons(module)}
                            </div>
                        `;

                        modulesTree.appendChild(moduleEl);
                    });

                    // Add toggle functionality
                    document.querySelectorAll('.module-header').forEach(header => {
                        header.addEventListener('click', function(e) {
                            // Don't toggle if clicking on action buttons
                            if (e.target.closest('.module-actions')) return;

                            const moduleId = this.dataset.moduleId;
                            const body = document.getElementById(`module-body-${moduleId}`);
                            const isCollapsed = this.classList.toggle('collapsed');
                            body.style.display = isCollapsed ? 'none' : 'block';
                        });
                    });
                }

                function renderLessons(module) {
                    let html = '<ul class="lessons-list">';

                    if (!module.lessons || module.lessons.length === 0) {
                        html += `<li class="lesson-item text-muted"><div class="lesson-info"><i class="bi bi-file-earmark me-2"></i>No lessons yet. Click + to add one.</div></li>`;
                    } else {
                        module.lessons.forEach((lesson, index) => {
                            const hasVideo = lesson.contentPath || lesson.videoPath;
                            const thumbnailHtml = lesson.thumbnailPath
                                ? `<img src="${lesson.thumbnailPath}" alt="${lesson.title}" class="lesson-thumbnail rounded" style="width: 32px; height: 24px; object-fit: cover;">`
                                : `<div class="lesson-thumbnail-default bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 32px; height: 24px;"><i class="bi bi-book text-white" style="font-size: 0.75rem;"></i></div>`;
                            html += `
                                <li class="lesson-item" data-lesson-id="${lesson.id}">
                                    <div class="lesson-info">
                                        ${thumbnailHtml}
                                        <span>${lesson.title}</span>
                                        ${hasVideo ? '<span class="badge bg-info ms-2">Video</span>' : ''}
                                    </div>
                                    <div class="lesson-actions">
                                        ${hasVideo ? `<a href="${lesson.contentPath || lesson.videoPath}" target="_blank" class="btn btn-sm btn-outline-info" title="Preview"><i class="bi bi-eye"></i></a>` : ''}
                                        <button class="btn btn-sm btn-outline-primary edit-lesson-trigger" data-lesson-id="${lesson.id}" data-lesson-title="${lesson.title}" data-lesson-thumbnail="${lesson.thumbnailPath || ''}" title="Edit Lesson">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-lesson-trigger" data-lesson-id="${lesson.id}" data-module-id="${module.id}" title="Delete Lesson">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </li>
                            `;
                        });
                    }

                    // Add quiz item at the end if exists
                    if (module.quiz) {
                        html += `
                            <li class="lesson-item quiz-item" data-quiz-id="${module.quiz.id}">
                                <div class="lesson-info">
                                    <div class="lesson-thumbnail-default bg-primary rounded d-flex align-items-center justify-content-center" style="width: 32px; height: 24px;">
                                        <i class="bi bi-question-circle text-white" style="font-size: 0.75rem;"></i>
                                    </div>
                                    <span>${module.quiz.title}</span>
                                    <span class="badge bg-primary ms-2">Quiz</span>
                                    <span class="badge bg-secondary ms-1">${module.quiz.questions ? module.quiz.questions.length : 0} questions</span>
                                </div>
                                <div class="lesson-actions">
                                    <a href="/Instructor/Quiz/ManageQuestions/${module.quiz.id}" class="btn btn-sm btn-outline-info" title="Manage Questions">
                                        <i class="bi bi-list-check"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-primary edit-quiz-trigger" data-quiz-id="${module.quiz.id}" data-quiz-title="${module.quiz.title}" data-module-id="${module.id}" title="Edit Quiz">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-quiz-trigger" data-quiz-id="${module.quiz.id}" data-module-id="${module.id}" title="Delete Quiz">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </li>
                        `;
                    }

                    html += '</ul>';
                    return html;
                }

                // Add Module
                document.getElementById('add-module-btn').addEventListener('click', async function() {
                    const titleInput = document.getElementById('new-module-title');
                    const thumbnailInput = document.getElementById('new-module-thumbnail');
                    const title = titleInput.value.trim();
                    const thumbnailFile = thumbnailInput.files[0];

                    if (!title) {
                        showAlert('Please enter a module title.', 'warning');
                        return;
                    }

                    try {
                        // Create module
                        const response = await fetch(`/api/Modules/ByCourse/${courseId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': requestVerificationToken
                            },
                            body: JSON.stringify({ title: title, orderIndex: modulesData.length + 1 })
                        });

                        if (!response.ok) {
                            showAlert('Failed to add module.', 'error');
                            return;
                        }

                        const module = await response.json();

                        // Upload thumbnail if provided
                        if (thumbnailFile) {
                            const formData = new FormData();
                            formData.append('thumbnail', thumbnailFile);

                            const thumbnailResponse = await fetch(`/api/Modules/${module.id}/Thumbnail`, {
                                method: 'POST',
                                headers: { 'RequestVerificationToken': requestVerificationToken },
                                body: formData
                            });

                            if (!thumbnailResponse.ok) {
                                showAlert('Module added but thumbnail upload failed.', 'warning');
                            }
                        }

                        // Reset form
                        titleInput.value = '';
                        thumbnailInput.value = '';
                        addModuleModal.hide();
                        showAlert('Module added successfully.', 'success');
                        loadModules();
                    } catch (error) {
                        showAlert('An error occurred while adding the module.', 'error');
                    }
                });

                // Add Lesson trigger
                modulesTree.addEventListener('click', function(e) {
                    const addLessonBtn = e.target.closest('.add-lesson-trigger');
                    if (addLessonBtn) {
                        e.stopPropagation();
                        const moduleId = addLessonBtn.dataset.moduleId;
                        document.getElementById('lesson-module-id').value = moduleId;
                        document.getElementById('new-lesson-title').value = '';
                        document.getElementById('new-lesson-thumbnail').value = '';
                        document.getElementById('lesson-video-upload').value = '';
                        addLessonModal.show();
                    }
                });

                // Helper function to get video duration
                function getVideoDuration(file) {
                    return new Promise((resolve, reject) => {
                        const video = document.createElement('video');
                        video.preload = 'metadata';

                        video.onloadedmetadata = function() {
                            window.URL.revokeObjectURL(video.src);
                            const duration = Math.round(video.duration);
                            resolve(duration);
                        };

                        video.onerror = function() {
                            window.URL.revokeObjectURL(video.src);
                            resolve(0); // Default to 0 if we can't read duration
                        };

                        video.src = URL.createObjectURL(file);
                    });
                }

                // Add Lesson
                document.getElementById('add-lesson-btn').addEventListener('click', async function() {
                    const moduleId = document.getElementById('lesson-module-id').value;
                    const title = document.getElementById('new-lesson-title').value.trim();
                    const thumbnailInput = document.getElementById('new-lesson-thumbnail');
                    const thumbnailFile = thumbnailInput.files[0];
                    const videoInput = document.getElementById('lesson-video-upload');
                    const videoFile = videoInput.files[0];

                    if (!title) {
                        showAlert('Please enter a lesson title.', 'warning');
                        return;
                    }

                    // Video file is required
                    if (!videoFile) {
                        showAlert('Please select a video file. Video is required for all lessons.', 'warning');
                        return;
                    }

                    // Validate video file type
                    if (videoFile.type !== 'video/mp4') {
                        showAlert('Invalid video format. Only MP4 files are allowed.', 'warning');
                        return;
                    }

                    // Validate video file size (500MB max)
                    if (videoFile.size > 500 * 1024 * 1024) {
                        showAlert('Video file is too large. Maximum size is 500MB.', 'warning');
                        return;
                    }

                    // Calculate the next order index
                    const module = modulesData.find(m => m.id == moduleId);
                    const lessonCount = module && module.lessons ? module.lessons.length : 0;
                    const orderIndex = lessonCount + 1;

                    // Disable the button and show progress
                    const addLessonBtn = document.getElementById('add-lesson-btn');
                    const originalBtnText = addLessonBtn.innerHTML;
                    addLessonBtn.disabled = true;
                    addLessonBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Reading video...';

                    let createdLessonId = null;

                    try {
                        // Get video duration before creating lesson
                        const videoDuration = await getVideoDuration(videoFile);

                        addLessonBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Uploading...';

                        // Create lesson first with the video duration
                        const lessonResponse = await fetch(`/api/Lessons/ByModule/${moduleId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': requestVerificationToken
                            },
                            body: JSON.stringify({ title: title, contentType: 0, durationSeconds: videoDuration, orderIndex: orderIndex })
                        });

                        if (!lessonResponse.ok) {
                            const errorText = await lessonResponse.text();
                            throw new Error(`Failed to create lesson: ${errorText || lessonResponse.status}`);
                        }

                        const lesson = await lessonResponse.json();
                        createdLessonId = lesson.id;

                        // Upload video (required) - this must succeed
                        const videoFormData = new FormData();
                        videoFormData.append('file', videoFile);

                        const uploadResponse = await fetch(`/api/Lessons/${lesson.id}/upload-video`, {
                            method: 'POST',
                            headers: { 'RequestVerificationToken': requestVerificationToken },
                            body: videoFormData
                        });

                        if (!uploadResponse.ok) {
                            const errorData = await uploadResponse.json().catch(() => ({}));
                            throw new Error(errorData.error || 'Video upload failed. Please try again.');
                        }

                        // Upload thumbnail if provided (optional - don't fail if this fails)
                        if (thumbnailFile) {
                            const thumbnailFormData = new FormData();
                            thumbnailFormData.append('thumbnail', thumbnailFile);

                            await fetch(`/api/Lessons/${lesson.id}/Thumbnail`, {
                                method: 'POST',
                                headers: { 'RequestVerificationToken': requestVerificationToken },
                                body: thumbnailFormData
                            });
                        }

                        // Success!
                        addLessonModal.hide();
                        showAlert('Lesson added successfully!', 'success');
                        loadModules();

                    } catch (error) {
                        // If lesson was created but video upload failed, delete the lesson
                        if (createdLessonId) {
                            try {
                                await fetch(`/api/Lessons/${createdLessonId}`, {
                                    method: 'DELETE',
                                    headers: { 'RequestVerificationToken': requestVerificationToken }
                                });
                            } catch (deleteError) {
                                console.error('Failed to cleanup lesson after video upload failure:', deleteError);
                            }
                        }
                        showAlert(error.message || 'An error occurred while adding the lesson.', 'error');
                    } finally {
                        // Re-enable the button
                        addLessonBtn.disabled = false;
                        addLessonBtn.innerHTML = originalBtnText;
                    }
                });

                // Edit Module trigger
                modulesTree.addEventListener('click', function(e) {
                    const editBtn = e.target.closest('.edit-module-trigger');
                    if (editBtn) {
                        e.stopPropagation();
                        const moduleId = editBtn.dataset.moduleId;
                        const moduleTitle = editBtn.dataset.moduleTitle;
                        const moduleThumbnail = editBtn.dataset.moduleThumbnail;
                        document.getElementById('edit-module-id').value = moduleId;
                        document.getElementById('edit-module-title').value = moduleTitle;
                        document.getElementById('edit-module-thumbnail').value = '';

                        // Update thumbnail preview
                        const previewContainer = document.getElementById('edit-module-thumbnail-preview');
                        if (moduleThumbnail) {
                            previewContainer.innerHTML = `<img src="${moduleThumbnail}" alt="Module thumbnail" class="img-thumbnail" style="max-height: 90px;">`;
                        } else {
                            previewContainer.innerHTML = `<div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 120px; height: 90px;"><i class="bi bi-layers text-white" style="font-size: 2rem;"></i></div>`;
                        }

                        editModuleModal.show();
                    }
                });

                // Save Module Edit
                document.getElementById('save-module-btn').addEventListener('click', async function() {
                    const moduleId = document.getElementById('edit-module-id').value;
                    const title = document.getElementById('edit-module-title').value.trim();
                    const thumbnailInput = document.getElementById('edit-module-thumbnail');
                    const thumbnailFile = thumbnailInput.files[0];

                    if (!title) {
                        showAlert('Please enter a module title.', 'warning');
                        return;
                    }

                    try {
                        // Update module title
                        const response = await fetch(`/api/Modules/${moduleId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': requestVerificationToken
                            },
                            body: JSON.stringify({ title: title })
                        });

                        if (!response.ok) {
                            showAlert('Failed to update module.', 'error');
                            return;
                        }

                        // Upload thumbnail if provided
                        if (thumbnailFile) {
                            const formData = new FormData();
                            formData.append('thumbnail', thumbnailFile);

                            const thumbnailResponse = await fetch(`/api/Modules/${moduleId}/Thumbnail`, {
                                method: 'POST',
                                headers: { 'RequestVerificationToken': requestVerificationToken },
                                body: formData
                            });

                            if (!thumbnailResponse.ok) {
                                showAlert('Module updated but thumbnail upload failed.', 'warning');
                                editModuleModal.hide();
                                loadModules();
                                return;
                            }
                        }

                        editModuleModal.hide();
                        showAlert('Module updated successfully.', 'success');
                        loadModules();
                    } catch (error) {
                        showAlert('An error occurred while updating the module.', 'error');
                    }
                });

                // Delete Module
                modulesTree.addEventListener('click', function(e) {
                    const deleteBtn = e.target.closest('.delete-module-trigger');
                    if (deleteBtn) {
                        e.stopPropagation();
                        const moduleId = deleteBtn.dataset.moduleId;

                        showDeleteConfirm('Are you sure you want to delete this module and all its lessons?', async () => {
                            try {
                                const response = await fetch(`/api/Modules/${moduleId}`, {
                                    method: 'DELETE',
                                    headers: { 'RequestVerificationToken': requestVerificationToken }
                                });

                                if (response.ok) {
                                    showAlert('Module deleted successfully.', 'success');
                                    loadModules();
                                } else {
                                    showAlert('Failed to delete module.', 'error');
                                }
                            } catch (error) {
                                showAlert('An error occurred while deleting the module.', 'error');
                            }
                        });
                    }
                });

                // Delete Lesson
                modulesTree.addEventListener('click', function(e) {
                    const deleteBtn = e.target.closest('.delete-lesson-trigger');
                    if (deleteBtn) {
                        e.stopPropagation();
                        const lessonId = deleteBtn.dataset.lessonId;

                        showDeleteConfirm('Are you sure you want to delete this lesson?', async () => {
                            try {
                                const response = await fetch(`/api/Lessons/${lessonId}`, {
                                    method: 'DELETE',
                                    headers: { 'RequestVerificationToken': requestVerificationToken }
                                });

                                if (response.ok) {
                                    showAlert('Lesson deleted successfully.', 'success');
                                    loadModules();
                                } else {
                                    showAlert('Failed to delete lesson.', 'error');
                                }
                            } catch (error) {
                                showAlert('An error occurred while deleting the lesson.', 'error');
                            }
                        });
                    }
                });

                // Edit Lesson trigger
                modulesTree.addEventListener('click', function(e) {
                    const editBtn = e.target.closest('.edit-lesson-trigger');
                    if (editBtn) {
                        e.stopPropagation();
                        const lessonId = editBtn.dataset.lessonId;
                        const lessonTitle = editBtn.dataset.lessonTitle;
                        const lessonThumbnail = editBtn.dataset.lessonThumbnail;
                        document.getElementById('edit-lesson-id').value = lessonId;
                        document.getElementById('edit-lesson-title').value = lessonTitle;
                        document.getElementById('edit-lesson-thumbnail').value = '';

                        // Update thumbnail preview
                        const previewContainer = document.getElementById('edit-lesson-thumbnail-preview');
                        if (lessonThumbnail) {
                            previewContainer.innerHTML = `<img src="${lessonThumbnail}" alt="Lesson thumbnail" class="img-thumbnail" style="max-height: 90px;">`;
                        } else {
                            previewContainer.innerHTML = `<div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 120px; height: 90px;"><i class="bi bi-book text-white" style="font-size: 2rem;"></i></div>`;
                        }

                        editLessonModal.show();
                    }
                });

                // Save Lesson Edit
                document.getElementById('save-lesson-btn').addEventListener('click', async function() {
                    const lessonId = document.getElementById('edit-lesson-id').value;
                    const title = document.getElementById('edit-lesson-title').value.trim();
                    const thumbnailInput = document.getElementById('edit-lesson-thumbnail');
                    const thumbnailFile = thumbnailInput.files[0];

                    if (!title) {
                        showAlert('Please enter a lesson title.', 'warning');
                        return;
                    }

                    try {
                        // Update lesson title
                        const response = await fetch(`/api/Lessons/${lessonId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': requestVerificationToken
                            },
                            body: JSON.stringify({ title: title })
                        });

                        if (!response.ok) {
                            showAlert('Failed to update lesson.', 'error');
                            return;
                        }

                        // Upload thumbnail if provided
                        if (thumbnailFile) {
                            const formData = new FormData();
                            formData.append('thumbnail', thumbnailFile);

                            const thumbnailResponse = await fetch(`/api/Lessons/${lessonId}/Thumbnail`, {
                                method: 'POST',
                                headers: { 'RequestVerificationToken': requestVerificationToken },
                                body: formData
                            });

                            if (!thumbnailResponse.ok) {
                                showAlert('Lesson updated but thumbnail upload failed.', 'warning');
                                editLessonModal.hide();
                                loadModules();
                                return;
                            }
                        }

                        editLessonModal.hide();
                        showAlert('Lesson updated successfully.', 'success');
                        loadModules();
                    } catch (error) {
                        showAlert('An error occurred while updating the lesson.', 'error');
                    }
                });

                // Module Quiz Management
                const moduleQuizModal = new bootstrap.Modal(document.getElementById('moduleQuizModal'));

                // Inline Quiz Edit trigger
                modulesTree.addEventListener('click', function(e) {
                    const editBtn = e.target.closest('.edit-quiz-trigger');
                    if (editBtn) {
                        e.stopPropagation();
                        const quizId = editBtn.dataset.quizId;
                        const quizTitle = editBtn.dataset.quizTitle;
                        const moduleId = editBtn.dataset.moduleId;
                        document.getElementById('quiz-module-id').value = moduleId;
                        document.getElementById('quiz-id').value = quizId;
                        document.getElementById('quiz-title').value = quizTitle;
                        document.getElementById('existing-quiz-title').textContent = quizTitle;
                        document.getElementById('manage-questions-link').href = `/Instructor/Quiz/ManageQuestions/${quizId}`;
                        document.getElementById('quiz-exists').style.display = 'block';
                        document.getElementById('delete-quiz-btn').style.display = 'inline-block';
                        document.getElementById('save-quiz-btn').innerHTML = '<i class="bi bi-check-lg me-1"></i>Update Quiz';
                        moduleQuizModal.show();
                    }
                });

                // Inline Quiz Delete trigger
                modulesTree.addEventListener('click', function(e) {
                    const deleteBtn = e.target.closest('.delete-quiz-trigger');
                    if (deleteBtn) {
                        e.stopPropagation();
                        const quizId = deleteBtn.dataset.quizId;
                        const moduleId = deleteBtn.dataset.moduleId;

                        showDeleteConfirm('Are you sure you want to delete this quiz? All questions will be removed.', async () => {
                            try {
                                const response = await fetch(`/Instructor/Quiz/Delete/${quizId}?moduleId=${moduleId}`, {
                                    method: 'POST',
                                    headers: {
                                        'RequestVerificationToken': requestVerificationToken
                                    }
                                });

                                if (response.ok || response.redirected) {
                                    showAlert('Quiz deleted successfully!', 'success');
                                    loadModules();
                                } else {
                                    showAlert('Failed to delete quiz.', 'error');
                                }
                            } catch (error) {
                                showAlert('An error occurred while deleting the quiz.', 'error');
                            }
                        });
                    }
                });

                // Add Quiz link trigger
                modulesTree.addEventListener('click', function(e) {
                    const addQuizLink = e.target.closest('.add-quiz-link');
                    if (addQuizLink) {
                        e.preventDefault();
                        e.stopPropagation();
                        const moduleId = addQuizLink.dataset.moduleId;
                        const module = modulesData.find(m => m.id == moduleId);
                        const moduleTitle = module ? module.title : 'Module';
                        document.getElementById('quiz-module-id').value = moduleId;
                        document.getElementById('quiz-id').value = '';
                        document.getElementById('quiz-title').value = `${moduleTitle} Quiz`;
                        document.getElementById('quiz-exists').style.display = 'none';
                        document.getElementById('delete-quiz-btn').style.display = 'none';
                        document.getElementById('save-quiz-btn').innerHTML = '<i class="bi bi-plus-lg me-1"></i>Create Quiz';
                        moduleQuizModal.show();
                    }
                });

                async function loadQuizForModule(moduleId) {
                    const quizForm = document.getElementById('quiz-form');
                    const quizExists = document.getElementById('quiz-exists');
                    const saveBtn = document.getElementById('save-quiz-btn');
                    const deleteBtn = document.getElementById('delete-quiz-btn');

                    try {
                        const response = await fetch(`/Instructor/Quiz/Manage/${moduleId}`, {
                            headers: { 'Accept': 'application/json' }
                        });

                        // Check if quiz exists by trying to get quiz data
                        const quizResponse = await fetch(`/api/Quiz/ByModule/${moduleId}`);

                        if (quizResponse.ok) {
                            const quiz = await quizResponse.json();
                            // Quiz exists
                            document.getElementById('quiz-id').value = quiz.id;
                            document.getElementById('quiz-title').value = quiz.title;
                            document.getElementById('existing-quiz-title').textContent = quiz.title;
                            document.getElementById('manage-questions-link').href = `/Instructor/Quiz/ManageQuestions/${quiz.id}`;

                            quizExists.style.display = 'block';
                            deleteBtn.style.display = 'inline-block';
                            saveBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Update Quiz';
                        } else {
                            // No quiz exists
                            document.getElementById('quiz-id').value = '';
                            quizExists.style.display = 'none';
                            deleteBtn.style.display = 'none';
                            saveBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Create Quiz';
                        }
                    } catch (error) {
                        console.error('Error loading quiz:', error);
                        quizExists.style.display = 'none';
                        deleteBtn.style.display = 'none';
                        saveBtn.innerHTML = '<i class="bi bi-plus-lg me-1"></i>Create Quiz';
                    }
                }

                // Save/Create Quiz
                document.getElementById('save-quiz-btn').addEventListener('click', async function() {
                    const moduleId = document.getElementById('quiz-module-id').value;
                    const quizId = document.getElementById('quiz-id').value;
                    const title = document.getElementById('quiz-title').value.trim();

                    if (!title) {
                        showAlert('Please enter a quiz title.', 'warning');
                        return;
                    }

                    try {
                        let response;
                        if (quizId) {
                            // Update existing quiz
                            response = await fetch(`/Instructor/Quiz/Edit/${quizId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'RequestVerificationToken': requestVerificationToken
                                },
                                body: `Id=${quizId}&ModuleId=${moduleId}&Title=${encodeURIComponent(title)}`
                            });
                        } else {
                            // Create new quiz
                            response = await fetch(`/Instructor/Quiz/Create/${moduleId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'RequestVerificationToken': requestVerificationToken
                                },
                                body: `ModuleId=${moduleId}&Title=${encodeURIComponent(title)}`
                            });
                        }

                        if (response.ok || response.redirected) {
                            moduleQuizModal.hide();
                            showAlert(quizId ? 'Quiz updated successfully!' : 'Quiz created successfully! Add questions via Manage Questions.', 'success');
                            loadModules();
                        } else {
                            showAlert('Failed to save quiz.', 'error');
                        }
                    } catch (error) {
                        showAlert('An error occurred while saving the quiz.', 'error');
                    }
                });

                // Delete Quiz
                document.getElementById('delete-quiz-btn').addEventListener('click', async function() {
                    const quizId = document.getElementById('quiz-id').value;
                    const moduleId = document.getElementById('quiz-module-id').value;

                    if (!quizId) return;

                    if (!confirm('Are you sure you want to delete this quiz? All questions will be removed.')) {
                        return;
                    }

                    try {
                        const response = await fetch(`/Instructor/Quiz/Delete/${quizId}?moduleId=${moduleId}`, {
                            method: 'POST',
                            headers: {
                                'RequestVerificationToken': requestVerificationToken
                            }
                        });

                        if (response.ok || response.redirected) {
                            moduleQuizModal.hide();
                            showAlert('Quiz deleted successfully!', 'success');
                            loadModules();
                        } else {
                            showAlert('Failed to delete quiz.', 'error');
                        }
                    } catch (error) {
                        showAlert('An error occurred while deleting the quiz.', 'error');
                    }
                });

                // Initial load
                loadModules();
            });
        </script>
    }
}
